<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ciblage M&A — Recherche d'entreprises</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --blue:        #2563eb;
      --blue-dark:   #1d4ed8;
      --blue-light:  #eff6ff;
      --blue-border: #bfdbfe;
      --gray-50:     #f8fafc;
      --gray-100:    #f1f5f9;
      --gray-200:    #e2e8f0;
      --gray-300:    #cbd5e1;
      --gray-400:    #94a3b8;
      --gray-500:    #64748b;
      --gray-700:    #334155;
      --gray-900:    #0f172a;
      --green:       #059669;
      --green-light: #ecfdf5;
      --red:         #dc2626;
      --red-light:   #fef2f2;
      --amber:       #d97706;
      --amber-light: #fffbeb;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      min-height: 100vh;
    }

    /* ── Header ── */
    header {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: .625rem;
      text-decoration: none;
    }

    .logo-icon {
      width: 34px;
      height: 34px;
      background: var(--blue);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .logo-icon svg { color: white; }

    .logo-text {
      font-size: .9375rem;
      font-weight: 700;
      color: var(--gray-900);
      letter-spacing: -.02em;
    }

    .logo-sub {
      font-size: .75rem;
      color: var(--gray-500);
      font-weight: 400;
    }

    .logout-btn {
      display: flex;
      align-items: center;
      gap: .375rem;
      padding: .375rem .75rem;
      border: 1.5px solid var(--gray-200);
      border-radius: 7px;
      background: white;
      color: var(--gray-500);
      font-size: .8125rem;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all .15s;
    }

    .logout-btn:hover {
      border-color: var(--gray-300);
      color: var(--gray-700);
    }

    /* ── Main content ── */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    /* ── Search card ── */
    .search-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.75rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgb(0 0 0 / .04);
    }

    .search-card h2 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: .25rem;
    }

    .search-card > p {
      font-size: .8125rem;
      color: var(--gray-500);
      margin-bottom: 1.25rem;
    }

    /* ── Form grid ── */
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: .875rem 1rem;
      margin-bottom: 1rem;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: .3125rem;
    }

    .field-group label {
      font-size: .6875rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .field-group input,
    .field-group select {
      padding: .5625rem .75rem;
      border: 1.5px solid var(--gray-200);
      border-radius: 7px;
      font-size: .875rem;
      font-family: inherit;
      color: var(--gray-900);
      outline: none;
      transition: border-color .15s;
      background: white;
      width: 100%;
    }

    .field-group input:focus,
    .field-group select:focus {
      border-color: var(--blue);
    }

    .field-group input::placeholder {
      color: var(--gray-400);
    }

    .field-group select {
      cursor: pointer;
    }

    .input-with-suffix {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-with-suffix input {
      padding-right: 2.5rem;
    }

    .input-with-suffix .suffix {
      position: absolute;
      right: .625rem;
      font-size: .75rem;
      color: var(--gray-400);
      pointer-events: none;
      white-space: nowrap;
    }

    /* ── Advanced filters (details/summary) ── */
    .advanced-filters {
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
    }

    .advanced-filters summary {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .75rem 1rem;
      font-size: .875rem;
      font-weight: 600;
      color: var(--gray-700);
      cursor: pointer;
      list-style: none;
      user-select: none;
      background: var(--gray-50);
    }

    .advanced-filters summary::-webkit-details-marker { display: none; }

    .advanced-filters summary .chevron {
      margin-left: auto;
      font-size: .75rem;
      color: var(--gray-400);
      transition: transform .2s;
    }

    details[open] .advanced-filters summary .chevron {
      transform: rotate(180deg);
    }

    .advanced-filters .adv-content {
      padding: 1rem;
      border-top: 1px solid var(--gray-200);
    }

    .advanced-filters .filters-grid {
      margin-bottom: 0;
    }

    /* ── Checkbox field ── */
    .field-checkbox {
      justify-content: flex-end;
    }

    .field-checkbox label {
      display: flex;
      align-items: center;
      gap: .5rem;
      text-transform: none;
      font-size: .875rem;
      color: var(--gray-700);
      font-weight: 500;
      letter-spacing: 0;
      cursor: pointer;
      margin-top: auto;
      padding-bottom: .125rem;
    }

    .field-checkbox input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      cursor: pointer;
      accent-color: var(--blue);
    }

    /* ── Search actions ── */
    .search-actions {
      display: flex;
      justify-content: flex-end;
      padding-top: .375rem;
    }

    .search-btn {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .6875rem 1.375rem;
      background: var(--blue);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: .9375rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      white-space: nowrap;
      transition: background .15s;
    }

    .search-btn:hover:not(:disabled) { background: var(--blue-dark); }
    .search-btn:disabled { opacity: .6; cursor: not-allowed; }

    /* ── Loading ── */
    .loading {
      display: none;
      align-items: center;
      gap: .75rem;
      padding: 1.25rem;
      background: var(--blue-light);
      border: 1px solid var(--blue-border);
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }

    .loading.visible { display: flex; }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2.5px solid var(--blue-border);
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text { font-size: .875rem; color: var(--blue-dark); }
    .loading-text strong { font-weight: 600; display: block; margin-bottom: .125rem; }
    .loading-text span { color: var(--blue); font-size: .8125rem; }

    /* ── Error ── */
    .error-box {
      display: none;
      padding: 1rem 1.25rem;
      background: var(--red-light);
      border: 1px solid #fecaca;
      border-radius: 10px;
      font-size: .875rem;
      color: var(--red);
      margin-bottom: 1.5rem;
      gap: .625rem;
      align-items: flex-start;
    }

    .error-box.visible { display: flex; }

    /* ── Results header ── */
    .results-header {
      display: none;
      align-items: center;
      justify-content: space-between;
      margin-bottom: .875rem;
    }

    .results-header.visible { display: flex; }

    .results-count {
      font-size: .875rem;
      color: var(--gray-500);
    }

    .results-count strong {
      color: var(--gray-900);
      font-weight: 600;
    }

    .export-btn {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .5rem 1rem;
      background: white;
      border: 1.5px solid var(--gray-200);
      border-radius: 8px;
      font-size: .8125rem;
      font-weight: 600;
      font-family: inherit;
      color: var(--gray-700);
      cursor: pointer;
      transition: all .15s;
    }

    .export-btn:hover {
      border-color: var(--green);
      color: var(--green);
    }

    /* ── Table ── */
    .table-wrap {
      display: none;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgb(0 0 0 / .04);
    }

    .table-wrap.visible { display: block; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .8125rem;
    }

    thead {
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
    }

    th {
      padding: .75rem 1rem;
      text-align: left;
      font-size: .6875rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: .05em;
      white-space: nowrap;
    }

    tbody tr {
      border-bottom: 1px solid var(--gray-100);
      transition: background .1s;
    }

    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--gray-50); }

    td {
      padding: .875rem 1rem;
      vertical-align: top;
      color: var(--gray-700);
    }

    .td-company strong {
      display: block;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: .125rem;
    }

    .td-company span {
      font-size: .75rem;
      color: var(--gray-400);
    }

    .td-ca { font-weight: 600; color: var(--gray-900); white-space: nowrap; }

    .age-badge {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: .1875rem .5rem;
      background: var(--amber-light);
      border: 1px solid #fde68a;
      border-radius: 20px;
      font-size: .75rem;
      font-weight: 500;
      color: var(--amber);
      margin-top: .25rem;
    }

    .contact-cell {
      font-size: .75rem;
      color: var(--gray-500);
    }

    .contact-cell a {
      color: var(--blue);
      text-decoration: none;
    }

    .contact-cell a:hover { text-decoration: underline; }

    .empty-cell { color: var(--gray-300); font-style: italic; }

    /* ── Empty state ── */
    .empty-state {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 2rem;
      text-align: center;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
    }

    .empty-state.visible { display: flex; }

    .empty-state svg { color: var(--gray-300); margin-bottom: 1rem; }
    .empty-state h3 { font-size: 1rem; color: var(--gray-700); margin-bottom: .375rem; }
    .empty-state p { font-size: .875rem; color: var(--gray-400); }

    /* ── Checkbox column ── */
    .col-check { width: 2.5rem; padding-left: 1rem !important; padding-right: .25rem !important; }
    .col-check input[type="checkbox"] {
      width: 1rem; height: 1rem; cursor: pointer; accent-color: var(--blue);
    }
    .col-check input[type="checkbox"]:disabled { opacity: .3; cursor: default; }

    /* ── Enrich button ── */
    .enrich-btn {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .5rem 1rem;
      background: white;
      border: 1.5px solid var(--gray-200);
      border-radius: 8px;
      font-size: .8125rem;
      font-weight: 600;
      font-family: inherit;
      color: var(--gray-700);
      cursor: pointer;
      transition: all .15s;
    }

    .enrich-btn:hover:not(:disabled) { border-color: var(--blue); color: var(--blue); }
    .enrich-btn:disabled { opacity: .5; cursor: not-allowed; }

    /* ── Enrich confirm box ── */
    .enrich-confirm {
      display: none;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgb(0 0 0 / .04);
    }

    .enrich-confirm.visible { display: block; }

    .enrich-confirm-header {
      display: flex;
      align-items: center;
      gap: .5rem;
      font-size: .9375rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: .625rem;
    }

    .enrich-summary {
      font-size: .875rem;
      color: var(--gray-600);
      margin-bottom: .875rem;
      line-height: 1.5;
    }

    .enrich-summary small { color: var(--gray-400); font-size: .8rem; }

    .enrich-confirm-actions {
      display: flex;
      gap: .5rem;
      justify-content: flex-end;
    }

    .btn-cancel-enrich {
      padding: .4375rem .875rem;
      border: 1.5px solid var(--gray-200);
      border-radius: 7px;
      background: white;
      color: var(--gray-600);
      font-size: .8125rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all .15s;
    }

    .btn-cancel-enrich:hover { border-color: var(--gray-300); color: var(--gray-900); }

    .btn-confirm-enrich {
      padding: .4375rem .875rem;
      border: none;
      border-radius: 7px;
      background: var(--blue);
      color: white;
      font-size: .8125rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: background .15s;
    }

    .btn-confirm-enrich:hover { background: var(--blue-dark); }

    /* ── Enrich type selector ── */
    .enrich-type-opt {
      display: flex;
      align-items: center;
      gap: .375rem;
      padding: .375rem .75rem;
      border: 1.5px solid var(--gray-200);
      border-radius: 7px;
      font-size: .8125rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all .15s;
      user-select: none;
    }

    .enrich-type-opt:has(input:checked) {
      border-color: var(--blue);
      background: var(--blue-light);
      color: var(--blue);
    }

    .enrich-type-opt input[type="radio"] {
      display: none;
    }

    /* ── Enrich loading ── */
    .enrich-loading {
      display: none;
      align-items: center;
      gap: .75rem;
      padding: 1rem 1.25rem;
      background: var(--blue-light);
      border: 1px solid var(--blue-border);
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .enrich-loading.visible { display: flex; }

    /* ── Enrich result ── */
    .enrich-result {
      display: none;
      padding: .625rem 1rem;
      background: var(--green-light);
      border: 1px solid #a7f3d0;
      border-radius: 8px;
      font-size: .875rem;
      color: var(--green);
      margin-bottom: 1rem;
    }

    .enrich-result.visible { display: block; }

    /* ── Responsive ── */
    @media (max-width: 900px) {
      .filters-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      .filters-grid { grid-template-columns: 1fr; }
      th, td { padding: .625rem .75rem; }
      .hide-mobile { display: none; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <a href="/" class="logo">
        <div class="logo-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
        </div>
        <div>
          <div class="logo-text">Ciblage M&A</div>
          <div class="logo-sub">Entreprises françaises</div>
        </div>
      </a>

      <nav style="display:flex;gap:0;border-bottom:none;height:60px">
        <a href="/" style="padding:0 1rem;height:60px;display:flex;align-items:center;font-size:.875rem;font-weight:600;color:var(--blue);text-decoration:none;border-bottom:2px solid var(--blue);">Recherche</a>
        <a href="/vendeurs" style="padding:0 1rem;height:60px;display:flex;align-items:center;font-size:.875rem;font-weight:500;color:var(--gray-500);text-decoration:none;border-bottom:2px solid transparent;transition:color .15s;" onmouseover="this.style.color='var(--gray-700)'" onmouseout="this.style.color='var(--gray-500)'">Base Vendeurs</a>
      </nav>

      <a href="/logout" class="logout-btn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
        Déconnexion
      </a>
    </div>
  </header>

  <!-- Main -->
  <main>

    <!-- Search card -->
    <div class="search-card">
      <h2>Critères de recherche</h2>
      <p>Renseignez au moins un critère pour lancer la recherche.</p>

      <form id="searchForm" onsubmit="event.preventDefault(); runSearch();">

        <!-- Filtres de base -->
        <div class="filters-grid">

          <div class="field-group">
            <label for="f-nom">Nom de l'entreprise</label>
            <input type="text" id="f-nom" name="nom_entreprise" placeholder="Dupont SAS, Plomberie…">
          </div>

          <div class="field-group">
            <label for="f-secteur">Secteur d'activité</label>
            <input type="text" id="f-secteur" name="secteur" placeholder="plomberie ou 4322A">
          </div>

          <div class="field-group">
            <label for="f-region">Région</label>
            <select id="f-region" name="region">
              <option value="">Toutes les régions</option>
              <option value="11">Île-de-France</option>
              <option value="24">Centre-Val de Loire</option>
              <option value="27">Bourgogne-Franche-Comté</option>
              <option value="28">Normandie</option>
              <option value="32">Hauts-de-France</option>
              <option value="44">Grand Est</option>
              <option value="52">Pays de la Loire</option>
              <option value="53">Bretagne</option>
              <option value="75">Nouvelle-Aquitaine</option>
              <option value="76">Occitanie</option>
              <option value="84">Auvergne-Rhône-Alpes</option>
              <option value="93">Provence-Alpes-Côte d'Azur</option>
              <option value="94">Corse</option>
              <option value="01">Guadeloupe</option>
              <option value="02">Martinique</option>
              <option value="03">Guyane</option>
              <option value="04">La Réunion</option>
              <option value="06">Mayotte</option>
            </select>
          </div>

          <div class="field-group">
            <label for="f-departement">Département</label>
            <input type="text" id="f-departement" name="departement" placeholder="75, 92, 69…">
          </div>

          <div class="field-group">
            <label for="f-ca-min">CA minimum</label>
            <div class="input-with-suffix">
              <input type="number" id="f-ca-min" name="ca_min" placeholder="2000000" min="0">
              <span class="suffix">€</span>
            </div>
          </div>

          <div class="field-group">
            <label for="f-ca-max">CA maximum</label>
            <div class="input-with-suffix">
              <input type="number" id="f-ca-max" name="ca_max" placeholder="6000000" min="0">
              <span class="suffix">€</span>
            </div>
          </div>

          <div class="field-group">
            <label for="f-age">Âge min dirigeant</label>
            <div class="input-with-suffix">
              <input type="number" id="f-age" name="age_min_dirigeant" placeholder="55" min="18" max="100">
              <span class="suffix">ans</span>
            </div>
          </div>

          <div class="field-group">
            <label for="f-dirigeant-nom">Nom du dirigeant</label>
            <input type="text" id="f-dirigeant-nom" name="nom_dirigeant" placeholder="Martin, Dupont…">
          </div>

          <div class="field-group">
            <label for="f-dirigeant-prenom">Prénom du dirigeant</label>
            <input type="text" id="f-dirigeant-prenom" name="prenom_dirigeant" placeholder="Jean, Marie…">
          </div>

          <div class="field-group">
            <label for="f-max">Max résultats</label>
            <input type="number" id="f-max" name="max_resultats" value="20" min="1" max="500">
          </div>

        </div>

        <!-- Filtres avancés -->
        <details class="advanced-filters">
          <summary>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/>
            </svg>
            Filtres avancés
            <span class="chevron">▾</span>
          </summary>
          <div class="adv-content">
            <div class="filters-grid">

              <div class="field-group">
                <label for="f-forme">Forme juridique</label>
                <select id="f-forme" name="forme_juridique">
                  <option value="">Toutes</option>
                  <option value="5710">SAS</option>
                  <option value="5720">SASU</option>
                  <option value="5499">SARL</option>
                  <option value="5498">EURL</option>
                  <option value="5599">SA</option>
                  <option value="5100">SNC</option>
                  <option value="6540">SCI</option>
                  <option value="1000">Entreprise individuelle</option>
                  <option value="7111">GIE</option>
                </select>
              </div>

              <div class="field-group">
                <label for="f-eff-min">Effectif min</label>
                <input type="number" id="f-eff-min" name="effectif_min" placeholder="1" min="0">
              </div>

              <div class="field-group">
                <label for="f-eff-max">Effectif max</label>
                <input type="number" id="f-eff-max" name="effectif_max" placeholder="50" min="0">
              </div>

              <div class="field-group">
                <label for="f-rn-min">Résultat net min</label>
                <div class="input-with-suffix">
                  <input type="number" id="f-rn-min" name="resultat_net_min" placeholder="-500000">
                  <span class="suffix">€</span>
                </div>
              </div>

              <div class="field-group">
                <label for="f-rn-max">Résultat net max</label>
                <div class="input-with-suffix">
                  <input type="number" id="f-rn-max" name="resultat_net_max" placeholder="1000000">
                  <span class="suffix">€</span>
                </div>
              </div>

              <div class="field-group">
                <label for="f-creation">Création depuis (année)</label>
                <input type="number" id="f-creation" name="date_creation_min" placeholder="2000" min="1900" max="2025">
              </div>

              <div class="field-group">
                <label for="f-ville">Ville</label>
                <input type="text" id="f-ville" name="ville" placeholder="Paris, Lyon…">
              </div>

              <div class="field-group">
                <label for="f-rcs">Statut RCS</label>
                <select id="f-rcs" name="statut_rcs">
                  <option value="">Tous</option>
                  <option value="inscrit">Inscrit</option>
                  <option value="radie">Radié</option>
                </select>
              </div>

              <div class="field-group field-checkbox">
                <label>
                  <input type="checkbox" name="en_activite" checked>
                  En activité uniquement
                </label>
              </div>

            </div>
          </div>
        </details>

        <div class="search-actions">
          <button class="search-btn" id="searchBtn" type="submit">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            Rechercher
          </button>
        </div>

      </form>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">
        <strong>Recherche en cours…</strong>
        <span id="loadingStep">Interrogation de la base Pappers…</span>
      </div>
    </div>

    <!-- Error -->
    <div class="error-box" id="errorBox">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span id="errorMsg"></span>
    </div>

    <!-- Results header -->
    <div class="results-header" id="resultsHeader">
      <div class="results-count" id="resultsCount"></div>
      <div style="display:flex;gap:.5rem;">
        <button class="enrich-btn" id="enrichBtn" onclick="openEnrichConfirm()">
          Enrichir les contacts
        </button>
        <button class="export-btn" id="addBaseBtn" onclick="addToBase()" style="border-color:var(--blue);color:var(--blue)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
          </svg>
          Ajouter à la base
        </button>
        <button class="export-btn" onclick="exportCSV()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Exporter CSV
        </button>
      </div>
    </div>

    <!-- Enrich confirm -->
    <div class="enrich-confirm" id="enrichConfirm">
      <div class="enrich-confirm-header">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
          <polyline points="22,6 12,13 2,6"/>
        </svg>
        Enrichissement Fullenrich
      </div>
      <div class="enrich-summary" id="enrichSummary"></div>

      <div style="display:flex;gap:.5rem;margin-bottom:.875rem;">
        <label class="enrich-type-opt">
          <input type="radio" name="enrichType" value="both" checked>
          <span>Email + Téléphone</span>
        </label>
        <label class="enrich-type-opt">
          <input type="radio" name="enrichType" value="email">
          <span>Email uniquement</span>
        </label>
        <label class="enrich-type-opt">
          <input type="radio" name="enrichType" value="phone">
          <span>Téléphone uniquement</span>
        </label>
      </div>

      <div class="enrich-confirm-actions">
        <button class="btn-cancel-enrich" onclick="cancelEnrich()">Annuler</button>
        <button class="btn-confirm-enrich" onclick="doEnrich()">Confirmer l'enrichissement →</button>
      </div>
    </div>

    <!-- Enrich loading -->
    <div class="enrich-loading" id="enrichLoading">
      <div class="spinner"></div>
      <div class="loading-text">
        <strong>Enrichissement en cours…</strong>
        <span>Interrogation de Fullenrich, cela prend généralement 15 à 30 secondes.</span>
      </div>
    </div>

    <!-- Enrich result -->
    <div class="enrich-result" id="enrichResult"></div>

    <!-- Add to base result -->
    <div class="enrich-result" id="addBaseResult" style="background:var(--blue-light);border-color:var(--blue-border);color:var(--blue-dark)"></div>

    <!-- Table -->
    <div class="table-wrap" id="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="col-check"><input type="checkbox" id="checkAll" title="Tout sélectionner" onchange="toggleSelectAll(this.checked)"></th>
            <th>Entreprise</th>
            <th>Chiffre d'affaires</th>
            <th class="hide-mobile">Résultat net</th>
            <th class="hide-mobile">Effectif</th>
            <th class="hide-mobile">Adresse</th>
            <th>Dirigeant</th>
            <th>Contact</th>
            <th class="hide-mobile">Fiche Pappers</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>

    <!-- Empty state -->
    <div class="empty-state" id="emptyState">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <h3>Aucune entreprise trouvée</h3>
      <p>Essayez d'élargir vos critères (secteur, région, CA, âge du dirigeant).</p>
    </div>

  </main>

  <script>
    let currentResults = [];

    // ── Utilitaires UI ──────────────────────────────────────────────────────
    function show(id)  { document.getElementById(id).classList.add('visible'); }
    function hide(id)  { document.getElementById(id).classList.remove('visible'); }
    function hideAll() {
      ['loading', 'errorBox', 'resultsHeader', 'tableWrap', 'emptyState',
       'enrichConfirm', 'enrichLoading', 'enrichResult', 'addBaseResult']
        .forEach(hide);
      const checkAll = document.getElementById('checkAll');
      if (checkAll) { checkAll.checked = false; checkAll.indeterminate = false; }
    }

    function setLoadingStep(msg) {
      document.getElementById('loadingStep').textContent = msg;
    }

    // ── Formatage ───────────────────────────────────────────────────────────
    function fmtCA(val) {
      if (!val && val !== 0) return '<span class="empty-cell">—</span>';
      const n = Number(val);
      if (n >= 1_000_000) return (n / 1_000_000).toLocaleString('fr-FR', {maximumFractionDigits: 1}) + '&nbsp;M€';
      if (n >= 1_000)     return (n / 1_000).toLocaleString('fr-FR', {maximumFractionDigits: 0}) + '&nbsp;k€';
      return n.toLocaleString('fr-FR') + '&nbsp;€';
    }

    function fmtRN(val) {
      if (val === '' || val === null || val === undefined) return '<span class="empty-cell">—</span>';
      const n = Number(val);
      if (isNaN(n)) return '<span class="empty-cell">—</span>';
      const abs = Math.abs(n);
      let fmt;
      if (abs >= 1_000_000) fmt = (abs / 1_000_000).toLocaleString('fr-FR', {maximumFractionDigits: 1}) + '&nbsp;M€';
      else if (abs >= 1_000) fmt = (abs / 1_000).toLocaleString('fr-FR', {maximumFractionDigits: 0}) + '&nbsp;k€';
      else fmt = abs.toLocaleString('fr-FR') + '&nbsp;€';
      const color = n < 0 ? 'var(--red)' : n > 0 ? 'var(--green)' : 'var(--gray-700)';
      const prefix = n < 0 ? '−' : '';
      return `<span style="color:${color};font-weight:600">${prefix}${fmt}</span>`;
    }

    function esc(s) {
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function empty(s) {
      return !s ? '<span class="empty-cell">—</span>' : esc(String(s));
    }

    // ── Rendu tableau ───────────────────────────────────────────────────────
    function renderResults(results) {
      const tbody = document.getElementById('resultsBody');
      tbody.innerHTML = '';
      const checkAll = document.getElementById('checkAll');
      if (checkAll) { checkAll.checked = false; checkAll.indeterminate = false; }

      results.forEach((r, i) => {
        const canEnrich = !!(r._enrich && (r._enrich.nom || r._enrich.prenom));

        const dirLine = r.nom_dirigeant
          ? `<div>${esc(r.nom_dirigeant)}</div>
             ${r.age_dirigeant ? `<span class="age-badge">⏳ ${r.age_dirigeant} ans</span>` : ''}`
          : '<span class="empty-cell">—</span>';

        let contact = '';
        if (r.email_dirigeant)  contact += `<a href="mailto:${esc(r.email_dirigeant)}">${esc(r.email_dirigeant)}</a><br>`;
        if (r.mobile_dirigeant) contact += esc(r.mobile_dirigeant);
        if (!contact)           contact  = '<span class="empty-cell">—</span>';

        const tr = document.createElement('tr');
        const pappersCell = r.pappers_url
          ? `<a href="${esc(r.pappers_url)}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:.25rem;color:var(--blue);font-size:.75rem;text-decoration:none;white-space:nowrap;">
               <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
               Voir
             </a>`
          : '<span class="empty-cell">—</span>';

        tr.innerHTML = `
          <td class="col-check"><input type="checkbox" class="row-check" data-idx="${i}" ${canEnrich ? '' : 'disabled'} onchange="updateEnrichBtn()"></td>
          <td class="td-company">
            <strong>${esc(r.nom_entreprise) || '—'}</strong>
            <span>${esc(r.siren)}</span>
            ${r.site_web ? `<br><a href="https://${esc(r.site_web)}" target="_blank" style="font-size:.75rem;color:var(--blue)">${esc(r.site_web)}</a>` : ''}
          </td>
          <td class="td-ca">${fmtCA(r.chiffre_affaires)}</td>
          <td class="hide-mobile">${fmtRN(r.resultat_net)}</td>
          <td class="hide-mobile">${empty(r.effectif)}</td>
          <td class="hide-mobile" style="max-width:180px;font-size:.75rem;color:var(--gray-500)">${empty(r.adresse)}</td>
          <td class="contact-cell">${dirLine}</td>
          <td class="contact-cell">${contact}</td>
          <td class="hide-mobile">${pappersCell}</td>
        `;
        tbody.appendChild(tr);
      });

      updateEnrichBtn();
    }

    function toggleSelectAll(checked) {
      document.querySelectorAll('.row-check:not(:disabled)').forEach(cb => cb.checked = checked);
      updateEnrichBtn();
    }

    function getCheckedIndices() {
      return [...document.querySelectorAll('.row-check:checked')].map(cb => parseInt(cb.dataset.idx));
    }

    function updateEnrichBtn() {
      const btn = document.getElementById('enrichBtn');
      if (!btn) return;
      const checked = getCheckedIndices();
      const enrichable = document.querySelectorAll('.row-check:not(:disabled)').length;
      const n = checked.length;

      // Mise à jour checkbox "tout sélectionner"
      const checkAll = document.getElementById('checkAll');
      if (checkAll && enrichable > 0) {
        checkAll.checked = n === enrichable;
        checkAll.indeterminate = n > 0 && n < enrichable;
      }

      if (n === 0) {
        btn.textContent = 'Enrichir les contacts';
        btn.disabled = enrichable === 0;
      } else {
        btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Enrichir (${n} sélectionné${n > 1 ? 's' : ''})`;
        btn.disabled = false;
      }
    }

    // ── Recherche principale ────────────────────────────────────────────────
    async function runSearch() {
      const form = document.getElementById('searchForm');
      const btn  = document.getElementById('searchBtn');

      const payload = {
        nom_entreprise:    form.nom_entreprise.value.trim(),
        nom_dirigeant:     form.nom_dirigeant.value.trim(),
        prenom_dirigeant:  form.prenom_dirigeant.value.trim(),
        secteur:           form.secteur.value.trim(),
        region:            form.region.value,
        departement:       form.departement.value.trim(),
        ca_min:            form.ca_min.value,
        ca_max:            form.ca_max.value,
        age_min_dirigeant: form.age_min_dirigeant.value,
        max_resultats:     form.max_resultats.value || 20,
        // Filtres avancés
        forme_juridique:   form.forme_juridique.value,
        effectif_min:      form.effectif_min.value,
        effectif_max:      form.effectif_max.value,
        resultat_net_min:  form.resultat_net_min.value,
        resultat_net_max:  form.resultat_net_max.value,
        date_creation_min: form.date_creation_min.value,
        ville:             form.ville.value.trim(),
        statut_rcs:        form.statut_rcs.value,
        en_activite:       form.en_activite.checked,
      };

      btn.disabled = true;
      hideAll();
      show('loading');
      setLoadingStep('Interrogation de la base Pappers…');

      const loadingTimer = setTimeout(() => {
        setLoadingStep('Récupération des détails des entreprises…');
      }, 4000);

      try {
        const res = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await res.json();

        if (!res.ok) {
          showError(data.error || 'Une erreur inattendue est survenue.');
          return;
        }

        currentResults = data.results || [];

        if (currentResults.length === 0) {
          show('emptyState');
        } else {
          const n = currentResults.length;
          document.getElementById('resultsCount').innerHTML =
            `<strong>${n}</strong> entreprise${n > 1 ? 's' : ''} trouvée${n > 1 ? 's' : ''}`;
          show('resultsHeader');
          renderResults(currentResults);
          show('tableWrap');
        }

      } catch (e) {
        showError('Erreur de connexion au serveur. Veuillez réessayer.');
      } finally {
        clearTimeout(loadingTimer);
        hide('loading');
        btn.disabled = false;
      }
    }

    function showError(msg) {
      document.getElementById('errorMsg').textContent = msg;
      show('errorBox');
    }

    // ── Enrichissement Fullenrich ────────────────────────────────────────────
    let pendingEnrichContacts = [];

    async function openEnrichConfirm() {
      // Utilise les lignes cochées, ou toutes les enrichissables si aucune cochée
      const checkedIdx = getCheckedIndices();
      const indices = checkedIdx.length > 0
        ? checkedIdx
        : currentResults.map((_, i) => i);

      pendingEnrichContacts = indices
        .map(i => ({ index: i, ...(currentResults[i]._enrich || {}) }))
        .filter(c => c.nom || c.prenom);

      if (!pendingEnrichContacts.length) {
        alert('Aucun dirigeant identifié dans la sélection — enrichissement impossible.');
        return;
      }

      hide('enrichResult');
      const n = pendingEnrichContacts.length;

      // Récupération du solde Fullenrich
      let balanceHtml = '<em>chargement…</em>';
      const summary = document.getElementById('enrichSummary');
      summary.innerHTML = `<strong>${n}</strong> dirigeant${n > 1 ? 's' : ''} à soumettre &nbsp;·&nbsp; Solde : ${balanceHtml}<br><small>Les crédits Fullenrich ne sont consommés que si un résultat est trouvé.</small>`;
      show('enrichConfirm');

      try {
        const r = await fetch('/api/fullenrich/credits');
        const d = await r.json();
        const bal = d.balance ?? '?';
        summary.innerHTML = `<strong>${n}</strong> dirigeant${n > 1 ? 's' : ''} à soumettre &nbsp;·&nbsp; Solde actuel : <strong>${bal}</strong> crédit${bal !== 1 ? 's' : ''}<br><small>Les crédits Fullenrich ne sont consommés que si un résultat est trouvé.</small>`;
      } catch { /* garde le message "chargement…" */ }
    }

    function cancelEnrich() {
      hide('enrichConfirm');
      pendingEnrichContacts = [];
    }

    async function doEnrich() {
      hide('enrichConfirm');
      show('enrichLoading');
      document.getElementById('enrichBtn').disabled = true;

      const enrichType = document.querySelector('input[name="enrichType"]:checked')?.value || 'both';

      const contacts = pendingEnrichContacts.map(c => ({
        prenom:       c.prenom       || '',
        nom:          c.nom          || '',
        domain:       c.domain       || '',
        company_name: c.company_name || '',
      }));

      try {
        const res = await fetch('/api/fullenrich/enrich', {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ contacts, enrich_type: enrichType }),
        });
        const data = await res.json();

        if (!res.ok) {
          showError(data.error || 'Erreur lors de l\'enrichissement Fullenrich.');
          return;
        }

        // Mise à jour de currentResults avec les emails / mobiles
        (data.enriched || []).forEach((e, j) => {
          const origIdx = pendingEnrichContacts[j]?.index;
          if (origIdx !== undefined) {
            currentResults[origIdx].email_dirigeant  = e.email  || '';
            currentResults[origIdx].mobile_dirigeant = e.mobile || '';
          }
        });

        // Re-rendu du tableau
        renderResults(currentResults);

        const found = (data.enriched || []).filter(e => e.email || e.mobile).length;
        const total = contacts.length;
        const credits = data.credits_used ?? 0;
        const result = document.getElementById('enrichResult');
        result.innerHTML = `Enrichissement terminé : <strong>${found}/${total}</strong> contact${found !== 1 ? 's' : ''} enrichi${found !== 1 ? 's' : ''} &nbsp;·&nbsp; ${credits} crédit${credits !== 1 ? 's' : ''} consommé${credits !== 1 ? 's' : ''}.`;
        show('enrichResult');

      } catch (e) {
        showError('Erreur de connexion lors de l\'enrichissement.');
      } finally {
        hide('enrichLoading');
        document.getElementById('enrichBtn').disabled = false;
        pendingEnrichContacts = [];
      }
    }

    // ── Ajouter à la base vendeurs ──────────────────────────────────────────
    async function addToBase() {
      if (!currentResults.length) return;
      const checkedIdx = getCheckedIndices();
      const indices = checkedIdx.length > 0 ? checkedIdx : currentResults.map((_,i) => i);
      const toAdd = indices.map(i => currentResults[i]);

      const btn = document.getElementById('addBaseBtn');
      btn.disabled = true;
      btn.textContent = 'Ajout en cours…';

      let added = 0, duplicates = 0, errors = 0;
      for (const r of toAdd) {
        try {
          const res = await fetch('/api/vendeurs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(r),
          });
          if (res.status === 409) duplicates++;
          else if (res.ok) added++;
          else errors++;
        } catch { errors++; }
      }

      btn.disabled = false;
      btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Ajouter à la base';

      let msg = `${added} entreprise${added !== 1 ? 's' : ''} ajoutée${added !== 1 ? 's' : ''} à la base vendeurs`;
      if (duplicates) msg += ` · ${duplicates} doublon${duplicates !== 1 ? 's' : ''} ignoré${duplicates !== 1 ? 's' : ''}`;
      if (errors) msg += ` · ${errors} erreur${errors !== 1 ? 's' : ''}`;
      const r = document.getElementById('addBaseResult');
      r.textContent = msg + '.';
      r.classList.add('visible');
      setTimeout(() => r.classList.remove('visible'), 4000);
    }

    // ── Export CSV ──────────────────────────────────────────────────────────
    async function exportCSV() {
      if (!currentResults.length) return;
      try {
        const res = await fetch('/api/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ results: currentResults }),
        });
        if (!res.ok) { alert("Erreur lors de l'export."); return; }
        const blob = await res.blob();
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        const cd   = res.headers.get('Content-Disposition') || '';
        const fn   = cd.match(/filename=([^;]+)/)?.[1] || 'entreprises.csv';
        a.href = url; a.download = fn; a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert("Erreur lors de l'export CSV.");
      }
    }
  </script>
</body>
</html>
